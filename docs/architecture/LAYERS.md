# Divisione Layers - GoalGrow

## Overview Architettura

GoalGrow implementa un'architettura a **4 layer** ben separati, seguendo i principi di Clean Architecture e DDD.

```
????????????????????????????????????????????????????
?  GoalGrow.API (Presentation Layer)              ?
?  - Controllers, DTOs, Middlewares                ?
?  - Dependency: Application, Domain               ?
????????????????????????????????????????????????????
?  GoalGrow.Application (Application Layer)       ?  ? DA CREARE
?  - Services, Use Cases, Validators               ?
?  - Dependency: Domain, Infrastructure            ?
????????????????????????????????????????????????????
?  GoalGrow.Entity (Domain Layer)                 ?
?  - Entities, Value Objects, Enums                ?
?  - Dependency: NESSUNA                           ?
????????????????????????????????????????????????????
?  GoalGrow.Data (Infrastructure Layer)           ?
?  - EF Core, DbContext, Configurations            ?
?  - Dependency: Domain                            ?
????????????????????????????????????????????????????
```

---

## Layer 1: Domain (`GoalGrow.Entity`)

### Responsabilità
- Definire le **entità di business**
- Contenere la **logica di dominio**
- Rappresentare **Value Objects** e **Aggregates**
- Definire **invariant** di business

### Struttura Directory

```
GoalGrow.Entity/
??? Common/
?   ??? AuditableEntity.cs           # Base class con CreatedAt, UpdatedAt
?   ??? FullAuditableEntity.cs       # Aggiunge CreatedBy, UpdatedBy
??? Enums/
?   ??? UserType.cs
?   ??? GoalStatus.cs
?   ??? InvestmentStatus.cs
?   ??? RiskLevel.cs
?   ??? ... (30+ enums)
??? Models/
?   ??? User.cs
?   ??? AdminUser.cs
?   ??? ConsultantUser.cs
?   ??? InversotorUser.cs
?   ??? Goal.cs
?   ??? Investment.cs
?   ??? Portfolio.cs
?   ??? Transaction.cs
?   ??? KycVerification.cs
?   ??? PlatformFee.cs
?   ??? ... (25+ entities)
??? Super/
?   ??? User.cs                      # Abstract base User class
??? ValueObjects/
    ??? Money.cs
    ??? DateRange.cs
    ??? ContactInfo.cs
    ??? Rating.cs
```

### Caratteristiche Chiave

#### 1. Zero Dipendenze Esterne
```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
  </PropertyGroup>
  
  <!-- NO package references! Solo .NET standard -->
</Project>
```

#### 2. Rich Domain Model
```csharp
public class Goal
{
    // Encapsulated state
    public Guid Id { get; private set; } = Guid.CreateVersion7();
    public decimal CurrentAmount { get; private set; }
    
    // Factory methods
    public static Goal CreateEmergencyGoal(Guid userId, decimal target) { /* ... */ }
    
    // Business logic
    public void Deposit(decimal amount)
    {
        ValidateDeposit(amount);
        CurrentAmount += amount;
        CheckCompletion();
    }
    
    // Invariants
    private void ValidateDeposit(decimal amount)
    {
        if (amount <= 0)
            throw new DomainException("Amount must be positive");
        
        if (Status == GoalStatus.Completed)
            throw new DomainException("Cannot deposit to completed goal");
    }
}
```

### Package da NON aggiungere
- ? Entity Framework
- ? ASP.NET Core
- ? AutoMapper
- ? Qualsiasi libreria infrastructure

---

## Layer 2: Infrastructure (`GoalGrow.Data`)

### Responsabilità
- Implementare **persistenza** dati
- Configurare **EF Core** mapping
- Gestire **migration** database
- Implementare **repository** (via DbSet)

### Struttura Directory

```
GoalGrow.Data/
??? Configurations/
?   ??? UserConfiguration.cs
?   ??? GoalConfiguration.cs
?   ??? InvestmentConfiguration.cs
?   ??? Financial/
?   ?   ??? PlatformFeeConfiguration.cs
?   ??? Compliance/
?       ??? KycVerificationConfiguration.cs
??? Contexts/
?   ??? FinancialDbContext.cs        # Partial context (Goals, Budgets, Tx)
?   ??? InvestmentDbContext.cs       # Partial context (Portfolio, Investments)
?   ??? GamificationDbContext.cs     # Partial context (Badges, Challenges)
??? Migrations/
?   ??? ... (auto-generated by EF)
??? GoalGrowDbContext.cs             # Main DbContext (combina tutti)
```

### Caratteristiche Chiave

#### 1. Fluent API Configuration
```csharp
public class GoalConfiguration : IEntityTypeConfiguration<Goal>
{
    public void Configure(EntityTypeBuilder<Goal> builder)
    {
        builder.ToTable("Goals");
        builder.HasKey(g => g.Id);
        
        // Indici per performance
        builder.HasIndex(g => new { g.UserId, g.Status })
            .HasDatabaseName("IX_Goals_UserId_Status");
        
        // Foreign key con Restrict
        builder.HasOne(g => g.User)
            .WithMany()
            .HasForeignKey(g => g.UserId)
            .OnDelete(DeleteBehavior.Restrict);
        
        // Money precision
        builder.Property(g => g.TargetAmount)
            .HasPrecision(18, 2);
        
        // Required fields
        builder.Property(g => g.Name)
            .IsRequired()
            .HasMaxLength(200);
    }
}
```

#### 2. DbContext Modulare
```csharp
public partial class GoalGrowDbContext : DbContext
{
    // DbSets
    public DbSet<User> Users { get; set; }
    public DbSet<Goal> Goals { get; set; }
    public DbSet<Investment> Investments { get; set; }
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        
        // Auto-discover configurations
        modelBuilder.ApplyConfigurationsFromAssembly(typeof(GoalGrowDbContext).Assembly);
        
        // TPH for User inheritance
        modelBuilder.Entity<User>()
            .HasDiscriminator<UserType>("UserType")
            .HasValue<AdminUser>(UserType.AdminUser)
            .HasValue<InversotorUser>(UserType.InvestorUser)
            .HasValue<ConsultantUser>(UserType.ConsultantUser);
    }
}
```

### Package Necessari
```xml
<PackageReference Include="Microsoft.EntityFrameworkCore" Version="10.0.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="10.0.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Relational" Version="10.0.0" />
```

---

## Layer 3: Application (`GoalGrow.Application`) ?? DA CREARE

### Responsabilità
- Implementare **use cases** applicativi
- Coordinare **domain objects**
- Gestire **transazioni**
- **Validare** input utente
- **Mappare** domain ? DTOs

### Struttura Proposta

```
GoalGrow.Application/              ? DA CREARE
??? Services/
?   ??? Interfaces/
?   ?   ??? IUserService.cs
?   ?   ??? IGoalService.cs
?   ?   ??? IInvestmentService.cs
?   ?   ??? IConsultantService.cs
?   ??? Implementations/
?       ??? UserService.cs
?       ??? GoalService.cs
?       ??? InvestmentService.cs
?       ??? ConsultantService.cs
??? DTOs/
?   ??? Requests/
?   ?   ??? CreateGoalRequest.cs
?   ?   ??? DepositToGoalRequest.cs
?   ?   ??? CreateInvestmentRequest.cs
?   ??? Responses/
?       ??? GoalResponse.cs
?       ??? InvestmentResponse.cs
?       ??? UserResponse.cs
??? Mappings/
?   ??? MappingProfile.cs          # AutoMapper profiles
??? Validators/
?   ??? CreateGoalRequestValidator.cs
?   ??? DepositToGoalRequestValidator.cs
??? Exceptions/
    ??? ValidationException.cs
    ??? BusinessRuleException.cs
```

### Esempio Service

```csharp
public interface IGoalService
{
    Task<GoalResponse> CreateGoalAsync(CreateGoalRequest request, Guid userId);
    Task<GoalResponse> DepositToGoalAsync(Guid goalId, decimal amount, Guid userId);
    Task<List<GoalResponse>> GetUserGoalsAsync(Guid userId);
    Task<GoalResponse> CompleteGoalAsync(Guid goalId, Guid userId);
}

public class GoalService : IGoalService
{
    private readonly GoalGrowDbContext _context;
    private readonly IMapper _mapper;
    private readonly ILogger<GoalService> _logger;

    public async Task<GoalResponse> CreateGoalAsync(CreateGoalRequest request, Guid userId)
    {
        // 1. Validazione (FluentValidation)
        var validator = new CreateGoalRequestValidator();
        await validator.ValidateAndThrowAsync(request);
        
        // 2. Business logic (Domain)
        var goal = new Goal(
            request.Name,
            request.TargetAmount,
            request.TargetDate,
            userId
        );
        goal.Description = request.Description;
        goal.Category = request.Category;
        goal.Priority = request.Priority;
        
        // 3. Persistence
        _context.Goals.Add(goal);
        await _context.SaveChangesAsync();
        
        // 4. Logging
        _logger.LogInformation("Goal {GoalId} created by user {UserId}", goal.Id, userId);
        
        // 5. Mapping to DTO
        return _mapper.Map<GoalResponse>(goal);
    }
}
```

### Package Necessari
```xml
<PackageReference Include="AutoMapper.Extensions.Microsoft.DependencyInjection" />
<PackageReference Include="FluentValidation.AspNetCore" />
<PackageReference Include="Microsoft.Extensions.Logging.Abstractions" />
```

---

## Layer 4: Presentation (`GoalGrow.API`)

### Responsabilità
- Esporre **REST API** endpoints
- Gestire **autenticazione/autorizzazione**
- **Validare** request HTTP
- **Serializzare** response JSON
- Gestire **errori** globalmente

### Struttura Directory

```
GoalGrow.API/
??? Controllers/
?   ??? AuthController.cs
?   ??? UsersController.cs           ? DA CREARE
?   ??? GoalsController.cs           ? DA CREARE
?   ??? InvestmentsController.cs     ? DA CREARE
?   ??? ConsultantsController.cs     ? DA CREARE
?   ??? HealthController.cs
??? DTOs/
?   ??? Requests/
?   ?   ??? LoginRequest.cs
?   ??? Responses/
?       ??? ApiResponse.cs
?       ??? LoginResponse.cs
??? Extensions/
?   ??? ClaimsPrincipalExtensions.cs
?   ??? ServiceCollectionExtensions.cs
??? Middlewares/
?   ??? ExceptionHandlerMiddleware.cs ? DA CREARE
?   ??? RequestLoggingMiddleware.cs   ? DA CREARE
??? Services/
?   ??? Interfaces/
?   ?   ??? IAuthService.cs
?   ??? Implementations/
?       ??? AuthService.cs
??? Program.cs
```

### Esempio Controller

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class GoalsController : ControllerBase
{
    private readonly IGoalService _goalService;
    private readonly ILogger<GoalsController> _logger;

    [HttpGet]
    [ProducesResponseType(typeof(ApiResponse<List<GoalResponse>>), 200)]
    public async Task<IActionResult> GetMyGoals()
    {
        var userId = User.GetUserId(); // Extension method
        var goals = await _goalService.GetUserGoalsAsync(userId);
        
        return Ok(ApiResponse<List<GoalResponse>>.SuccessResponse(goals));
    }

    [HttpPost]
    [ProducesResponseType(typeof(ApiResponse<GoalResponse>), 201)]
    [ProducesResponseType(400)]
    public async Task<IActionResult> CreateGoal([FromBody] CreateGoalRequest request)
    {
        var userId = User.GetUserId();
        var goal = await _goalService.CreateGoalAsync(request, userId);
        
        return CreatedAtAction(
            nameof(GetGoal), 
            new { id = goal.Id }, 
            ApiResponse<GoalResponse>.SuccessResponse(goal, "Goal created")
        );
    }

    [HttpPost("{id}/deposit")]
    [ProducesResponseType(typeof(ApiResponse<GoalResponse>), 200)]
    public async Task<IActionResult> DepositToGoal(
        Guid id, 
        [FromBody] DepositToGoalRequest request)
    {
        var userId = User.GetUserId();
        var goal = await _goalService.DepositToGoalAsync(id, request.Amount, userId);
        
        return Ok(ApiResponse<GoalResponse>.SuccessResponse(goal, "Deposit successful"));
    }
}
```

### Package Necessari
```xml
<PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" />
<PackageReference Include="Swashbuckle.AspNetCore" />
<PackageReference Include="Scalar.AspNetCore" />
```

---

## Dependency Injection Setup

### Program.cs

```csharp
var builder = WebApplication.CreateBuilder(args);

// Configuration
var configuration = builder.Configuration;
var connectionString = configuration.GetConnectionString("GoalGrowDb");

// Layer 1: Infrastructure (Data)
builder.Services.AddDbContext<GoalGrowDbContext>(options =>
    options.UseSqlServer(connectionString));

// Layer 2: Application Services
builder.Services.AddScoped<IUserService, UserService>();
builder.Services.AddScoped<IGoalService, GoalService>();
builder.Services.AddScoped<IInvestmentService, InvestmentService>();
builder.Services.AddScoped<IConsultantService, ConsultantService>();

// Layer 3: Presentation (Auth, Mapping, Validation)
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options => { /* Keycloak config */ });

builder.Services.AddAutoMapper(typeof(MappingProfile));
builder.Services.AddValidatorsFromAssemblyContaining<CreateGoalRequestValidator>();

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// Middleware pipeline
app.UseHttpsRedirection();
app.UseAuthentication();
app.UseAuthorization();
app.MapControllers();
app.Run();
```

---

## Flusso Richiesta HTTP

```
Client Request
    ?
[1] Middleware (Logging, Exception Handling)
    ?
[2] Controller (Presentation Layer)
    ? Validates JWT, extracts UserId
    ?
[3] Service (Application Layer)
    ? Validates request
    ? Coordinates domain objects
    ?
[4] Domain Logic (Domain Layer)
    ? Business rules executed
    ?
[5] Repository/DbContext (Infrastructure Layer)
    ? Persists to database
    ?
[6] Response mapped to DTO
    ?
Client Response (JSON)
```

---

## Best Practices per Layer

### Domain Layer
- ? NO dipendenze esterne
- ? Business logic nelle entities
- ? Immutabilità per Value Objects
- ? Factory methods per creazione complessa

### Infrastructure Layer
- ? Configuration separata per entity
- ? Indici per performance
- ? FK con Restrict (no cascade)
- ? Precision decimal per money (18,2)

### Application Layer
- ? Use case = 1 metodo service
- ? Validazione input (FluentValidation)
- ? Transaction management
- ? Logging business events

### Presentation Layer
- ? Controller thin (delega a service)
- ? Authorization per endpoint
- ? DTOs per input/output (NO entity)
- ? Gestione errori centralizzata

---

## Anti-Pattern da Evitare

### ? Layer Mixing
```csharp
// SBAGLIATO: Controller accede direttamente a DbContext
public class GoalsController : ControllerBase
{
    private readonly GoalGrowDbContext _context; // NO!
    
    [HttpPost]
    public async Task<IActionResult> Create(CreateGoalRequest request)
    {
        var goal = new Goal(request.Name, request.Amount, ...);
        _context.Goals.Add(goal); // Business logic nel controller!
        await _context.SaveChangesAsync();
        return Ok(goal);
    }
}
```

### ? Corretto
```csharp
public class GoalsController : ControllerBase
{
    private readonly IGoalService _goalService; // Service layer
    
    [HttpPost]
    public async Task<IActionResult> Create(CreateGoalRequest request)
    {
        var goal = await _goalService.CreateGoalAsync(request, User.GetUserId());
        return Ok(ApiResponse<GoalResponse>.SuccessResponse(goal));
    }
}
```

---

## Roadmap Layer Implementation

### Current State ?
- [x] Domain Layer completo
- [x] Infrastructure Layer completo
- [x] Presentation Layer base (auth)

### Next Phase ??
- [ ] Creare **GoalGrow.Application** project
- [ ] Implementare Services
- [ ] Aggiungere AutoMapper
- [ ] Aggiungere FluentValidation
- [ ] Implementare Controllers CRUD

### Future ??
- [ ] Layer separato per CQRS
- [ ] Event Bus per domain events
- [ ] Background services per jobs

---

**Autore**: Edoardo Carollo  
**Data**: 2025-01-18  
**Versione**: 1.0.0
